<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Williston Basin - NDIC Interactive GIS Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .info { background: white; padding: 6px 8px; font-size: 14px; border-radius: 8px; }
    .leaflet-popup-content { min-width: 220px; }
    .label-bold { font-weight: bold; color: #173250; }
    .popup-table td { padding: 2px 6px; }
  </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// --- Color palette for Bakken counties ---
const bakkenCountyColors = [
    "#1681a1", "#5eaf6e", "#e8a938", "#f2665b", "#a05edb", "#3eb5cb", "#e358a2", "#66994d"
];
const bakkenCounties = [
    "MCKENZIE", "DUNN", "WILLIAMS", "MOUNTRAIL", "DIVIDE", "BURKE", "BILLINGS", "STARK"
];

// Center on Williston Basin, ND
const map = L.map('map').setView([47.4, -102.8], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map & Data Â© NDIC, OpenStreetMap'
}).addTo(map);

let countyLayer = null;
async function addCounties() {
    // NDIC counties FeatureServer
    const url = "https://gis.dmr.nd.gov/dmrpublicservices/rest/services/OilGasPublicMapDataVectorTiles/Counties/FeatureServer/0/query?where=1=1&outFields=*&f=geojson";
    const geo = await fetch(url).then(r=>r.json());
    countyLayer = L.geoJSON(geo, {
        style: feature => {
            const idx = bakkenCounties.indexOf(feature.properties.NAME.trim().toUpperCase());
            if (idx >= 0) return {color: "#333", fillColor: bakkenCountyColors[idx % bakkenCountyColors.length], fillOpacity: 0.4, weight: 2};
            else return {color: "#bbb", fillColor:"#ddd", fillOpacity:0.05, weight: 1};
        },
        onEachFeature: (f, l) => {
            if (bakkenCounties.includes(f.properties.NAME.trim().toUpperCase())) {
                l.bindPopup(`<b>${f.properties.NAME} County</b><br>Click to zoom to county`);
                l.on("click", _=>{
                    map.fitBounds(l.getBounds());
                });
            }
        }
    }).addTo(map);
}
addCounties();

let townshipLayer = null;
function showTownships() {
    if (townshipLayer) map.removeLayer(townshipLayer);
    const baseurl = 'https://gis.dmr.nd.gov/dmrpublicservices/rest/services/OilGasPublicMapDataVectorTiles/PLSS_Townships/FeatureServer/0/query';
    const b = map.getBounds();
    const params = new URLSearchParams({
        where: '1=1',
            xmin: b.getWest(), ymin: b.getSouth(),
            xmax: b.getEast(), ymax: b.getNorth(),
            spatialReference: { wkid: 4326 }
        }),
        geometryType: 'esriGeometryEnvelope',
        inSR: 4326,
        spatialRel: 'esriSpatialRelIntersects',
        outFields: '*',
        returnGeometry: true,
        f: 'geojson'
    });
    fetch(`${baseurl}?${params}`).then(r => r.json()).then(data => {
        townshipLayer = L.geoJSON(data, {
            onEachFeature: function (f, l) {
                l.on('click', function() {
                    // Calls showSections without relying on popup buttons or window scope
                    showSections(f.properties.TOWNSHIP, f.properties.RANGE, f.geometry);
                });
                l.bindPopup(
                    `<div class="info">
                        <span class="label-bold">Township:</span> ${f.properties.TOWNSHIP}<br/>
                        <span class="label-bold">Range:</span> ${f.properties.RANGE}<br/>
                        <span>Click directly on the blue shape to show sections.</span>
                    </div>`
                );
            },
            style: { color: "#1050A0", weight: 1, fillOpacity: 0.10 }
        }).addTo(map);
    });
}
            style: { color: "#1050A0", weight: 1, fillOpacity: 0.10 }
        }).addTo(map);
    });
}
map.on('moveend', function() {
    if (map.getZoom() >= 9) showTownships();
    else if (townshipLayer) { map.removeLayer(townshipLayer); townshipLayer=null; }
});

// --- 3. Sections: overlay as a 6x6 grid on township polygon ---
window.showSections = (township, range, geomStr) => {
    if (!geometry || !geometry.coordinates) return alert('No section polygons!');
    if (window.sectionPolys) window.sectionPolys.forEach(l => map.removeLayer(l));
    window.sectionPolys = [];
    const b = L.geoJSON({type:'Feature',geometry}).getBounds();
    let minx=b.getWest(), maxx=b.getEast(), miny=b.getSouth(), maxy=b.getNorth();
    let dx=(maxx-minx)/6, dy=(maxy-miny)/6;
    for (let r=0; r<6; r++) for (let c=0; c<6; c++) {
        let sec = r*6+c+1;
        let poly = [
            [miny + r*dy, minx + c*dx], [miny + r*dy, minx + (c+1)*dx],
            [miny + (r+1)*dy, minx + (c+1)*dx], [miny + (r+1)*dy, minx + c*dx]
        ];
        let layer = L.polygon(poly, {color: "#EC7D19", weight: 1, fillOpacity: 0.18}).addTo(map);
        layer.bindPopup(`
            <span class="label-bold">Section ${sec}</span><br>
            <button onclick="window.showWells('${township}','${range}',${sec})">Show Wells</button>
        `);
        window.sectionPolys.push(layer);
    }
};

// --- 4. Well-level API call: Plot all wells in the selected TRS section as green points ---
window.showWells = async (township, range, section) => {
    // Remove previous well points
    if (window.wellMarkers) window.wellMarkers.forEach(m=>map.removeLayer(m));
    window.wellMarkers = [];
    // Query all wells in this TRS from NDIC (limit to Bakken)
    const wellBase = "https://gis.dmr.nd.gov/dmrpublicservices/rest/services/OilGasPublicMapDataVectorTiles/Wells/FeatureServer/0/query";
    let where = `TOWNSHIP='${township}' AND RNG='${range}' AND SEC=${section}`;
    // You can add "AND FORMATION='BAKKEN'" if you want Bakken-only:
    // where += " AND FORMATION='BAKKEN'";
    const params = new URLSearchParams({
        where: where,
        outFields: "*",
        returnGeometry: true,
        f: "geojson"
    });
    let wells = [];
    try {
        let res = await fetch(`${wellBase}?${params}`);
        let data = await res.json();
        wells = data.features || [];
    } catch(e) {
        alert('Could not fetch well data.');
    }
    wells.forEach(w=>{
        if(w.geometry && w.geometry.coordinates) {
            let marker = L.circleMarker([w.geometry.coordinates[1], w.geometry.coordinates[0]], {
                radius: 5, color: "#228B22", weight:2, fillOpacity:0.8
            }).addTo(map);
            marker.bindPopup(`
                <b>API: </b>${w.properties.API || 'N/A'}<br>
                <b>Well Name:</b> ${w.properties.WELL_NAME || 'N/A'}<br>
                <b>Operator:</b> ${w.properties.OPERATOR || 'N/A'}<br>
                <b>Status:</b> ${w.properties.STATUS || 'N/A'}<br>
                <b>Spud Date:</b> ${w.properties.SPUD_DATE || 'N/A'}<br>
            `);
            window.wellMarkers.push(marker);
        }
    });
    if (wells.length === 0) alert('No wells found in this section.');
};

// Auto-show townships if zoom is high on load
if (map.getZoom() >= 9) showTownships();

</script>
</body>
</html>

